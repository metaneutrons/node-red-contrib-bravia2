<script type="text/javascript">
  RED.nodes.registerType('bravia-api', {
    category: 'devices',
    color: '#b8535a',
    icon: 'tv.png',
    defaults: {
      tv: { type: 'bravia-tv', required: true },
      method: { value: '', validate: function(v) {
        return !this.polling || (v && v.length > 0);
      }},
      payload: { value: '', required: false },
      polling: { value: false },
      interval: { value: 10, validate: RED.validators.number() },
      intervalUnit: { value: 'seconds' },
      outputMode: { value: 'change' },
      name: { value: '', required: false }
    },
    inputs: 1,
    outputs: 1,
    align: 'right',
    label: function() {
      return this.name || 'bravia api';
    },
    oneditprepare: function() {
      var node = this;

      function populatePollMethods() {
        $.get('/bravia/methods/pollable').done(function(data) {
          $('#node-input-method-poll').empty();
          $('#node-input-method-poll').append('<option value="">-- select method --</option>');
          data.forEach(function(m) {
            $('#node-input-method-poll').append('<option value="' + m.value + '">' + m.label + '</option>');
          });
          if (node.method) {
            $('#node-input-method-poll').val(node.method);
          }
        });
      }

      function togglePollingUI() {
        var polling = $('#node-input-polling').is(':checked');
        if (polling) {
          $('#polling-options').show();
          $('#method-row-full').hide();
          $('#method-row-poll').show();
          $('#payload-row').hide();
          $('#method-usage').parent().hide();
        } else {
          $('#polling-options').hide();
          $('#method-row-full').show();
          $('#method-row-poll').hide();
          $('#payload-row').show();
          $('#method-usage').parent().show();
        }
      }

      populatePollMethods();
      $('#node-input-polling').on('change', togglePollingUI);
      togglePollingUI();

      function refreshUsage() {
        var value = $('#node-input-method').val();
        var config = RED.nodes.node($('#node-input-tv').val());

        if ($('#node-input-method').prop('tagName') === 'SELECT' && value && config && config.host && config.port && config.psk) {
          var selected = $('#node-input-method option:selected');
          $.get('/bravia/method', {
              host: config.host,
              port: config.port,
              psk: config.psk,
              protocol: selected.data('protocol'),
              version: selected.data('version'),
              method: selected.data('method')
            })
            .done(function(data) {
              var method = typeof data === 'string' ? JSON.parse(data) : data;
              var usage = '<p>Below is the usage information for:</p><p><b>' + selected.data('protocol') + ':' + selected.data('version') + ':' + selected.data('method') + '</b></p>';
              if (method[1].length > 0) {
                usage += 'Payload: <pre>';
                method[1].forEach(function(result, index) {
                  usage += result;
                  if (index < method[1].length - 1) {
                    usage += '<br />';
                  }
                });
                usage += '</pre>';
              }

              if (method[2].length > 0) {
                usage += 'Results: <pre>';
                method[2].forEach(function(result, index) {
                  usage += result;
                  if (index < (method[2].length - 1)) {
                    usage += ',<br />';
                  }
                });
                usage += '</pre>';
              }

              $('#method-usage').html(usage);
            })
            .fail(function() {
              RED.notify('Failed to retrieve API method usage for ' + config.host + ', check your TV connection settings.', 'error');
            });
        } else {
          $('#method-usage').text('Select an API method to show usage information.');
        }
      }

      $('#node-input-tv').on('change', function() {
        var value = $('#node-input-method').val();
        var config = RED.nodes.node($('#node-input-tv').val());

        $('#node-input-method').off('change');
        $('#node-input-method').replaceWith('<input type="text" id="node-input-method">');
        $('#node-input-method').val(value);
        refreshUsage();

        if (config && config.host && config.port && config.psk) {
          $.get('/bravia/methods', { host: config.host, port: config.port, psk: config.psk })
            .done(function(data) {
              var protocols = typeof data === 'string' ? JSON.parse(data) : data;
              if (protocols.length === 0) {
                RED.notify('No API methods retrieved from ' + config.host + ', check your TV connection settings.', 'error');
                return;
              }

              $('#node-input-method').replaceWith('<select id="node-input-method" style="width: 70%;"></select>');
              $('#node-input-method').append('<option value=""></option>');
              protocols.forEach(function(protocol) {
                var versions = protocol.versions;
                versions.forEach(function(version) {
                  var methods = version.methods;
                  methods.forEach(function(method) {
                    $('#node-input-method').append('<option value="' + protocol.protocol + ':' + version.version + ':' + method[0] + '" data-protocol="' + protocol.protocol + '" data-version="' + version.version + '" data-method="' + method[0] + '">' + protocol.protocol + ':' + version.version + ':' + method[0] + '</option>');
                  });
                });
              });

              $('#node-input-method').on('change', refreshUsage);
              $('#node-input-method').val(value);
              refreshUsage();
            })
            .fail(function() {
              RED.notify('Failed to retrieve API methods from ' + config.host + ', check your TV connection settings.', 'error');
            });
        }
      });
    },
    oneditsave: function() {
      var polling = $('#node-input-polling').is(':checked');
      if (polling) {
        var pollMethod = $('#node-input-method-poll').val();
        // Ensure the main method field has the value
        if ($('#node-input-method').prop('tagName') === 'SELECT') {
          $('#node-input-method').append('<option value="' + pollMethod + '">' + pollMethod + '</option>');
        }
        $('#node-input-method').val(pollMethod);
      }
    },
    oneditvalidate: function() {
      if (this.polling && !this.method) {
        return false;
      }
      return true;
    }
  });
</script>

<script type="text/x-red" data-template-name="bravia-api">
  <div class="form-row">
    <label for="node-input-tv"><i class="fa fa-television"></i> TV</label>
    <input type="text" id="node-input-tv">
  </div>

  <div class="form-row">
    <input type="checkbox" id="node-input-polling" style="width: auto; margin-right: 5px;">
    <label for="node-input-polling" style="width: auto;"> Enable polling</label>
  </div>

  <div id="method-row-full" class="form-row">
    <label for="node-input-method"><i class="fa fa-tasks"></i> Method</label>
    <input type="text" id="node-input-method">
  </div>

  <div id="method-row-poll" class="form-row" style="display: none;">
    <label for="node-input-method-poll"><i class="fa fa-tasks"></i> Method</label>
    <select id="node-input-method-poll" style="width: 70%;"></select>
  </div>

  <div id="payload-row" class="form-row">
    <label for="node-input-payload"><i class="fa fa-envelope"></i> Payload</label>
    <input type="text" id="node-input-payload">
  </div>

  <div id="polling-options" style="display: none;">
    <div class="form-row">
      <label for="node-input-interval"><i class="fa fa-clock-o"></i> Interval</label>
      <input type="number" id="node-input-interval" min="1" style="width: 60px;">
      <select id="node-input-intervalUnit" style="width: 100px;">
        <option value="seconds">seconds</option>
        <option value="minutes">minutes</option>
        <option value="hours">hours</option>
      </select>
    </div>

    <div class="form-row">
      <label for="node-input-outputMode"><i class="fa fa-sign-out"></i> Output</label>
      <select id="node-input-outputMode" style="width: 200px;">
        <option value="change">Only on change (RBE)</option>
        <option value="always">Every poll</option>
      </select>
    </div>
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-tips">
    <span id="method-usage">
      Select an API method to show usage information.
    </span>
  </div>
</script>

<script type="text/x-red" data-help-name="bravia-api">
  <p>Invokes a service protocol API method on a Sony BRAVIA Android TV.</p>

  <h3>Polling Mode</h3>
  <p>When enabled, the node periodically calls the selected method and outputs the result.</p>
  <p>Available polling methods:</p>
  <ul>
    <li><code>getPowerStatus</code> - Power state (works in standby)</li>
    <li><code>getVolumeInformation</code> - Volume/mute (requires TV on)</li>
    <li><code>getPlayingContentInfo</code> - Current input (requires TV on)</li>
    <li><code>getCurrentExternalInputsStatus</code> - HDMI connection status (works in standby)</li>
  </ul>

  <h3>Manual Mode</h3>
  <p>The method name can be specified either in the config or via <code>msg.method</code> and <b>MUST</b> be in the format <i>protocol:version:method</i>.</p>
  <p>The payload can be specified either in the config or via <code>msg.payload</code>.</p>

  <h3>RBE Mode</h3>
  <p>"Only on change" mode only emits when the result differs from the previous poll.</p>
</script>
